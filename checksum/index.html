<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checksum</title>
    <style>
      body {
        font-family: sans-serif;
        font-size: smaller;
        line-height: 1.9em;
        padding: 2em;
      }
      #divresult {
        padding: 1.5em;
        font-family: monospace;
        background-color: lightgray;
      }
    </style>
  </head>
  <body>
    <!-- FROM https://stackoverflow.com/questions/60595630/javascript-use-input-type-file-to-compute-sha256-file-hash -->
    <h1>Generating a checksum on the client before upload</h1>

    <p>
      This allows the server receiving the file to compare its own checksum
      against the file before it left the user's desktop.
    </p>

    <input type="file" id="fileselector" onchange="javascript:hashfile();" />

    <div id="divresult">(SHA-256 will appear here)</div>

    <p>
        The hash can be sent in a form element. If multiple files are being uploaded, they will each need their hashes calculated and sent.
    </p>
  </body>

  <script>
    function hashfile() {
      readbinaryfile(fileselector.files[0])
        .then(function (result) {
          result = new Uint8Array(result);
          return window.crypto.subtle.digest("SHA-256", result);
        })
        .then(function (result) {
          result = new Uint8Array(result);
          var resulthex = Uint8ArrayToHexString(result);
          divresult.innerText = "result: " + resulthex;
        });
    }

    function readbinaryfile(file) {
      return new Promise((resolve, reject) => {
        var fr = new FileReader();
        fr.onload = () => {
          resolve(fr.result);
        };
        fr.readAsArrayBuffer(file);
      });
    }

    function Uint8ArrayToHexString(ui8array) {
      var hexstring = "",
        h;
      for (var i = 0; i < ui8array.length; i++) {
        h = ui8array[i].toString(16);
        if (h.length == 1) {
          h = "0" + h;
        }
        hexstring += h;
      }
      var p = Math.pow(2, Math.ceil(Math.log2(hexstring.length)));
      hexstring = hexstring.padStart(p, "0");
      return hexstring;
    }
  </script>
</html>
